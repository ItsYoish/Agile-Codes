{% extends "base.html" %}

{% block title %}Invoice Management{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0 text-gray-800"><i class="fas fa-file-invoice-dollar me-2"></i>Invoice Management</h1>
                <a href="{{ url_for('create_invoice') }}" class="btn btn-primary"><i class="fas fa-plus me-2"></i>Create New Invoice</a>
            </div>
            
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">All Invoices</h6>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="filter-pending">Pending</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="filter-paid">Paid</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="filter-overdue">Overdue</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="filter-all">All</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="invoicesTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Invoice #</th>
                                    <th>Client</th>
                                    <th>Issue Date</th>
                                    <th>Due Date</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for invoice in invoices %}
                                <tr class="invoice-row" data-status="{{ invoice.status }}">
                                    <td>{{ invoice.invoice_number }}</td>
                                    <td>{{ invoice.client_name }}</td>
                                    <td>{{ invoice.issue_date.strftime('%Y-%m-%d') }}</td>
                                    <td>{{ invoice.due_date.strftime('%Y-%m-%d') }}</td>
                                    <td>£{{ "%.2f"|format(invoice.amount) }}</td>
                                    <td>
                                        {% if invoice.status == 'pending' %}
                                        <span class="badge bg-warning text-dark">Pending</span>
                                        {% elif invoice.status == 'paid' %}
                                        <span class="badge bg-success">Paid</span>
                                        {% elif invoice.status == 'overdue' %}
                                        <span class="badge bg-danger">Overdue</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ invoice.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            <a href="{{ url_for('edit_invoice', invoice_id=invoice.id) }}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button type="button" class="btn btn-sm btn-outline-success mark-paid" data-invoice-id="{{ invoice.id }}"
                                                    {% if invoice.status == 'paid' %}disabled{% endif %}>
                                                <i class="fas fa-check"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-xl-6 col-lg-7">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Invoice Overview</h6>
                        </div>
                        <div class="card-body">
                            <div class="chart-pie pt-4 pb-2">
                                <canvas id="invoiceStatusChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-6 col-lg-5">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Financial Summary</h6>
                        </div>
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-4 text-center">
                                    <div class="h4 mb-0 text-gray-800">Total</div>
                                    <div class="h3 mb-0 font-weight-bold text-gray-800" id="total-amount">£0.00</div>
                                </div>
                                <div class="col-4 text-center">
                                    <div class="h4 mb-0 text-gray-800">Paid</div>
                                    <div class="h3 mb-0 font-weight-bold text-success" id="paid-amount">£0.00</div>
                                </div>
                                <div class="col-4 text-center">
                                    <div class="h4 mb-0 text-gray-800">Due</div>
                                    <div class="h3 mb-0 font-weight-bold text-danger" id="due-amount">£0.00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Calculate totals
    let invoices = Array.from(document.querySelectorAll('.invoice-row'));
    let totalAmount = 0;
    let paidAmount = 0;
    let pendingAmount = 0;
    let overdueAmount = 0;
    
    let pendingCount = 0;
    let paidCount = 0;
    let overdueCount = 0;
    
    invoices.forEach(invoice => {
        let amount = parseFloat(invoice.cells[4].textContent.replace('£', ''));
        let status = invoice.dataset.status;
        
        totalAmount += amount;
        
        if (status === 'paid') {
            paidAmount += amount;
            paidCount++;
        } else if (status === 'pending') {
            pendingAmount += amount;
            pendingCount++;
        } else if (status === 'overdue') {
            overdueAmount += amount;
            overdueCount++;
        }
    });
    
    document.getElementById('total-amount').textContent = `£${totalAmount.toFixed(2)}`;
    document.getElementById('paid-amount').textContent = `£${paidAmount.toFixed(2)}`;
    document.getElementById('due-amount').textContent = `£${(pendingAmount + overdueAmount).toFixed(2)}`;
    
    // Setup chart
    var ctx = document.getElementById('invoiceStatusChart').getContext('2d');
    var myPieChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Paid', 'Pending', 'Overdue'],
            datasets: [{
                data: [paidCount, pendingCount, overdueCount],
                backgroundColor: ['#4e73df', '#f6c23e', '#e74a3b'],
                hoverBackgroundColor: ['#2e59d9', '#e3a820', '#d52a1a'],
                hoverBorderColor: 'rgba(234, 236, 244, 1)',
            }],
        },
        options: {
            maintainAspectRatio: false,
            tooltips: {
                backgroundColor: "rgb(255,255,255)",
                bodyFontColor: "#858796",
                borderColor: '#dddfeb',
                borderWidth: 1,
                xPadding: 15,
                yPadding: 15,
                displayColors: false,
                caretPadding: 10,
            },
            legend: {
                display: true,
                position: 'bottom'
            },
            cutoutPercentage: 70,
        },
    });
    
    // Filters
    document.getElementById('filter-pending').addEventListener('click', function() {
        filterInvoices('pending');
    });
    
    document.getElementById('filter-paid').addEventListener('click', function() {
        filterInvoices('paid');
    });
    
    document.getElementById('filter-overdue').addEventListener('click', function() {
        filterInvoices('overdue');
    });
    
    document.getElementById('filter-all').addEventListener('click', function() {
        filterInvoices('all');
    });
    
    function filterInvoices(status) {
        invoices.forEach(invoice => {
            if (status === 'all' || invoice.dataset.status === status) {
                invoice.style.display = '';
            } else {
                invoice.style.display = 'none';
            }
        });
    }
});
</script>
{% endblock %}
